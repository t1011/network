#!/bin/bash

ES_HOST="http://msk-tp-vasp-dn01:9200"
INDEX="msk-tp-nginx-logs-*"

# Полный запрос за 1 минуту
full_query=$(curl -s --max-time 5 -XGET "${ES_HOST}/${INDEX}/_search" -H 'Content-Type: application/json' -d '{
  "timeout": "5s",
  "size": 0,
  "query": {
    "bool": {
      "must": [
        { "query_string": { "query": "request:subject blob:foreign=0", "analyze_wildcard": true } },
        { "term": { "response": "302" } },
        { "term": { "msisdn.keyword": "-|-" } },
        { "range": { "@timestamp": { "gte": "now-1m/m", "lte": "now-1m/m" } } }
      ],
      "must_not": [ { "match_phrase": { "request": "/" } } ]
    }
  }
}')

# Извлечение total
bad_resp=$(echo "$full_query" | jq -r '.hits.total // 0')

# Корректировка
correction_bad_resp=$((bad_resp / 2))

# Вывод
if [[ -z "$correction_bad_resp" || "$correction_bad_resp" == "null" ]]; then
  echo "0 responses 302 last 1 min with foreign=0 and empty msisdn in Kibana | resp_302=0"
else
  echo "$correction_bad_resp responses 302 last 1 min with foreign=0 and empty msisdn in Kibana | resp_302=$correction_bad_resp"
fi
