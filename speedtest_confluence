#!/usr/bin/python3
import requests
import json
from requests.auth import HTTPBasicAuth

# Конфигурация для Confluence
CONFLUENCE_URL = "https://your-confluence-domain.atlassian.net/wiki/rest/api/content"
PAGE_ID = "15656567"  # Замените на ваш актуальный ID страницы
USERNAME = "your-email@example.com"
API_TOKEN = "your-api-token"

# Операторы для поиска
OPERATORS = ["megafon", "yota", "beeline", "mts", "t2"]

def fetch_servers_by_operator(operator):
    """Получение данных о серверах для указанного оператора."""
    url = f"https://www.speedtest.net/api/js/servers?engine=js&limit=1000&search={operator}"
    filter_country = "Russia"
    try:
        response = requests.get(url, timeout=10)
        response.raise_for_status()
        data = response.json()
    except requests.RequestException as e:
        print(f"Ошибка при запросе данных для {operator}: {e}")
        return {}

    grouped_data = {}
    for server in data:
        country = server["country"]
        city = server["name"]
        if filter_country and country != filter_country:
            continue
        if country not in grouped_data:
            grouped_data[country] = []
        grouped_data[country].append(city)
    
    return grouped_data

def generate_table(operator, grouped_data):
    """Генерация HTML-таблицы для оператора."""
    if not grouped_data:
        return f"<h2>{operator.capitalize()}</h2><p>Данные для {operator} отсутствуют</p>"
    
    table_rows = ""
    for country, cities in grouped_data.items():
        cities_str = ", ".join(sorted(cities))
        table_rows += f"<tr><td>{country}</td><td>{cities_str}</td></tr>"
    
    return f"""
    <h2>{operator.capitalize()}</h2>
    <table>
        <tr><th>Страна</th><th>Города</th></tr>
        {table_rows}
    </table>
    """

def get_current_page_version():
    """Получение текущей версии страницы."""
    page_url = f"{CONFLUENCE_URL}/{PAGE_ID}"
    try:
        response = requests.get(
            page_url,
            auth=HTTPBasicAuth(USERNAME, API_TOKEN)
        )
        response.raise_for_status()
        page_data = response.json()
        return page_data["version"]["number"]
    except requests.RequestException as e:
        print(f"Ошибка при получении версии страницы: {e}")
        return None

def update_confluence_page(content):
    """Обновление страницы Confluence."""
    page_url = f"{CONFLUENCE_URL}/{PAGE_ID}"
    current_version = get_current_page_version()
    if current_version is None:
        print("Не удалось определить версию страницы. Обновление отменено.")
        return

    headers = {"Content-Type": "application/json"}
    payload = {
        "id": PAGE_ID,
        "type": "page",
        "title": "Speedtest Servers by Operator",  # Укажите нужный заголовок
        "body": {
            "storage": {
                "value": content,
                "representation": "storage"
            }
        },
        "version": {"number": current_version + 1}
    }

    try:
        response = requests.put(
            page_url,
            auth=HTTPBasicAuth(USERNAME, API_TOKEN),
            headers=headers,
            data=json.dumps(payload)
        )
        response.raise_for_status()
        print("Страница Confluence успешно обновлена.")
    except requests.RequestException as e:
        print(f"Ошибка при обновлении страницы Confluence: {e}")

def main():
    """Основная логика скрипта."""
    all_data = {}
    for operator in OPERATORS:
        print(f"Сбор данных для {operator}...")
        all_data[operator] = fetch_servers_by_operator(operator)

    page_content = ""
    for operator in ["megafon", "yota", "beeline", "mts", "t2"]:
        table = generate_table(operator, all_data[operator])
        page_content += table

    update_confluence_page(page_content)

if __name__ == "__main__":
    main()
