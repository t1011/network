---
- name: Get unique disk models using ssacli
  hosts: all
  become: yes
  vars:
    all_unique_models: []  # Глобальная переменная для хранения всех моделей
  tasks:
    - name: Get disk models using ssacli
      ansible.builtin.shell: |
        sudo ssacli ctrl all show config detail | grep "Model:" | awk '{print $2}' | sort -u
      register: disk_models
      changed_when: false
      failed_when: disk_models.rc != 0 and disk_models.rc != 1

    - name: Collect unique disk models locally on each host
      ansible.builtin.set_fact:
        local_unique_models: "{{ disk_models.stdout_lines }}"

    - name: Aggregate unique disk models across all hosts
      ansible.builtin.set_fact:
        all_unique_models: "{{ all_unique_models | union(local_unique_models) }}"
      delegate_facts: true
      when: disk_models.stdout_lines is defined

    - name: Display unique disk models
      ansible.builtin.debug:
        msg: "{{ all_unique_models | sort }}"
      when: inventory_hostname == ansible_play_hosts[-1]
