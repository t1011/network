---
- name: Get unique disk models using ssacli
  hosts: all
  become: yes
  tasks:
    - name: Get disk models using ssacli
      ansible.builtin.shell: |
        ssacli ctrl all show config detail | grep "Model:" | awk '{print $3}' | sort -u
      register: disk_models
      changed_when: false
      failed_when: disk_models.rc != 0 and disk_models.rc != 1  # Игнорируем ошибки, если контроллера нет

    - name: Aggregate all disk models
      ansible.builtin.set_fact:
        all_unique_models: "{{ (ansible_play_hosts | map('extract', hostvars, 'disk_models') | map(attribute='stdout_lines') | flatten | unique) }}"
      delegate_to: localhost
      run_once: true
      when: inventory_hostname == ansible_play_hosts[-1]

    - name: Display unique disk models
      ansible.builtin.debug:
        msg: "{{ hostvars['localhost']['all_unique_models'] }}"
      delegate_to: localhost
      run_once: true
