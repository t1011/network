#!/bin/bash

ES_HOST="http://msk-tp-vasp-dn01:9200"

# Запрос к Elasticsearch за последнюю минуту с агрегацией по кодам ответа
response=$(curl -s --max-time 5 -XGET "${ES_HOST}/_search" -H 'Content-Type: application/json' -d '{
  "timeout": "5s",
  "size": 0,
  "query": {
    "bool": {
      "must": [
        { "query_string": { "query": "request: xmnpml", "analyze_wildcard": true } },
        { "range": { "@timestamp": { "gte": "now-1m/m", "lte": "now-1m/m" } } }
      ],
      "must_not": [ { "match_phrase": { "request": "/" } } ]
    }
  },
  "aggs": {
    "by_response": {
      "range": {
        "field": "response",
        "ranges": [
          { "from": 200, "to": 299 },
          { "from": 300, "to": 399 },
          { "from": 400, "to": 499 },
          { "from": 500, "to": 599 }
        ]
      }
    }
  }
}' | jq -r '{total: .hits.total, aggs: .aggregations.by_response.buckets}')

# Извлечение значений
total=$(echo "$response" | jq -r '.total')
resp_2xx=$(echo "$response" | jq -r '.aggs[0].doc_count')
resp_3xx=$(echo "$response" | jq -r '.aggs[1].doc_count')
resp_4xx=$(echo "$response" | jq -r '.aggs[2].doc_count')
resp_5xx=$(echo "$response" | jq -r '.aggs[3].doc_count')

# Корректировка из-за дублирования логов (деление на 2)
total_corrected=$((total / 2))
resp_2xx_corrected=$((resp_2xx / 2))
resp_3xx_corrected=$((resp_3xx / 2))
resp_4xx_corrected=$((resp_4xx / 2))
resp_5xx_corrected=$((resp_5xx / 2))

# Проверка результата и вывод
if [[ -z "$total_corrected" || "$total_corrected" == "null" ]]; then
  echo "0 total responses last 1 min to xmnpml requests in Kibana | total=0 resp_2xx=0 resp_3xx=0 resp_4xx=0 resp_5xx=0"
else
  echo "$total_corrected total responses last 1 min to xmnpml requests in Kibana | total=$total_corrected resp_2xx=$resp_2xx_corrected resp_3xx=$resp_3xx_corrected resp_4xx=$resp_4xx_corrected resp_5xx=$resp_5xx_corrected"
fi
